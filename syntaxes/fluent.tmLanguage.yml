scopeName: "source.ftl"

patterns:
- include: "#comment"
- include: "#message"
- include: "#wrong-line"

repository:
  comment:
    match: "^##?#?\\s.*$"
    name: "comment.fluent"

  message:
    begin: "^(-?[a-zA-Z][a-zA-Z0-9_-]*\\s*=\\s*)"
    end: "^(?=\\S)"
    beginCaptures:
      "1":
        name: "storage.type.message-identifier.fluent"
    contentName: "string.fluent"
    patterns:
      - include: "#attributes"
      - match: "\
        {\\s*\
          (\
            (-|\\$)[a-zA-Z0-9_-]+|\
            [a-zA-Z][a-zA-Z0-9_-]*|\
            [0-9]+\
          )\
        \\s*}"
        name: "variable.other.placeable.fluent"
      - include: "#placeable-string"
      - include: "#placeable-function"
      - include: "#selectors"
      - match: "{([^}A-Z]*$|[^-][^>]$)\\b" # invalid placeable - missing } or ->
        name: "invalid.illegal.wrong-placeable-missing-end.fluent"
      - match: "{\\s*\"[^\"]+$" # invalid placeable - string missing end "
        name: "invalid.illegal.wrong-placeable-missing-end-quote.fluent"
      - match: "{\\s*([0-9]\\S*\\(|[A-Z]*[^A-Z]\\S*\\()" # invalid placeable - wrong function name
        name: "invalid.illegal.wrong-placeable-name.fluent"
      - match: "{\\s*[0-9]+[^0-9]+\\s*}" # invalid placeable - start with number but has letters after
        name: "invalid.illegal.wrong-placeable-number-then-letters.fluent"

  attributes:
    begin: "\\s*(\\.[a-zA-Z][a-zA-Z0-9_-]*\\s*=\\s*)"
    end: "^(?=\\s*[^\\.])"
    beginCaptures:
      "1":
        name: "storage.type.attribute-begin.fluent"
    patterns:
      - match: "{\\s*(-|\\$)[a-zA-Z0-9_-]+\\s*}" # placeables
        name: "variable.other.placeable.fluent"
      - include: "#placeable-string"
      - include: "#placeable-function"
      - include: "#selectors"
      - match: "{([^}A-Z]*$|[^-][^>]$)\\b" # invalid placeable - missing } or ->
        name: "invalid.illegal.wrong-placeable-missing-end.fluent"
      - match: "{\\s*([0-9]\\S*\\(|[A-Z]*[^A-Z]\\S*\\()" # invalid placeable - wrong function name
        name: "invalid.illegal.wrong-placeable-name.fluent"

  placeable-function:
    begin: "({\\s*[A-Z][A-Z0-9_-]*\\()"
    end: "(\\)\\s*})"
    beginCaptures:
      "1":
        name: "variable.other.placeable-function-begin.fluent"
    endCaptures:
      "1":
        name: "variable.other.placeable-function-end.fluent"
    contentName: "string.placeable-function-content.fluent"

  placeable-string:
    begin: "({\\s*\")(?=[^\\n]*\")"
    end: "(\"\\s*})"
    beginCaptures:
      "1":
        name: "variable.other.placeable-string-begin.fluent"
    endCaptures:
      "1":
        name: "variable.other.placeable-string-end.fluent"
    contentName: "string.placeable-string-content.fluent"

  selectors:
    begin: "({\\s*\\$[a-zA-Z0-9_-]+\\s*->)"
    end: "(\\s*})"
    beginCaptures:
      "1":
        name: "variable.other.selector-begin.fluent"
    endCaptures:
      "1":
        name: "variable.other.selector-end.fluent"
    contentName: "string.selector-content.fluent"
    patterns:
      - include: "#selector-item"

  selector-item:
    begin: "(\\s*\\*?\\[[a-zA-Z0-9_-]+\\]\\s*)"
    end: "^(?=\\s)"
    beginCaptures:
      "1":
        name: "variable.other.selector-item-begin.fluent"
    contentName: "string.selector-item-content.fluent"

  wrong-line:
    match: ".*"
    name: "invalid.illegal.wrong-line.fluent"
